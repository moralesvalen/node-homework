# Task 1: total price per order

SELECT c.order_id, sum(p.price * c.quantity ) as total_price 
FROM line_items c
INNER JOIN products p ON c.product_id = p.product_id
where c.order_id in (select  order_id from orders order by order_id asc limit 5)
group by c.order_id order by c.order_id;

# Task 2: Understanding Subquerie average total

select a.customer_name, avg(a.total) average_order_price from (select  c.customer_name, sum(l.quantity*p.price) as total from customers c join orders o on c.customer_id = o.customer_id join line_items l on l.order_id = o.order_id join products p on p.product_id = l.product_id group by c.customer_name, o.order_id ) as a group by a.customer_name order by a.customer_name; 

# Task 3a: find customer_id
select  customer_id from customers where customer_name = 'Perez and Sons';

# Task 3b: find employee_id
select  employee_id from employees where first_name = 'Miranda' and last_name ='Harris';

# Task 3c: find product_id for 5 least expensive products
select  product_id from products order by price asc limit 5;

# Task 3d: Creating a New Order

BEGIN;
INSERT INTO orders (customer_id,employee_id,date) 
select
(select  customer_id from customers where customer_name = 'Perez and Sons'),
(select  employee_id from employees where first_name = 'Miranda' and last_name ='Harris'),
CURRENT_DATE
RETURNING order_id;
INSERT INTO line_items (order_id, product_id, quantity)
SELECT $1, p.product_id, 10
FROM (
  SELECT product_id
  FROM products
  ORDER BY price ASC
  LIMIT 5
) p;
COMMIT;

# Task 3e: find new order
select * from line_items where order_id in(select max(order_id) from orders );

# Task 4: Aggregation with Having
SELECT e.first_name, e.last_name, count(o.order_id) as order_count
FROM
employees e
JOIN orders o ON e.employee_id = o.employee_id
group by e.employee_id,e.first_name, e.last_name
having count(o.order_id) >5
ORDER BY e.last_name;